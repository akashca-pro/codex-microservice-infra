apiVersion: apps/v1
kind: Deployment
metadata: 
  name: code-execution-service
  namespace: app-services
spec: 
  replicas: 1
  selector:
    matchLabels:
      app: code-execution-service
  template:
    metadata:
      labels:
        app: code-execution-service
    spec:
      initContainers:
        - name: wait-for-redis
          image: busybox:1.36.1
          command:
            - sh
            - -c
            - |
              echo "Waiting for Redis to be available on port 6379..."
              until nc -z -w 1 redis 6379; do
                echo "Redis not yet ready. Sleeping for 5 seconds..."
                sleep 5
              done
              echo "Redis is ready!"
          env:
            - name: REDIS_HOST
              value: "redis"
          resources:
            requests:
              cpu: 10m
              memory: 10Mi
            limits:
              cpu: 100m
              memory: 64Mi
      containers:
      # container 1 code-execution-service app (Docker client)
        - name: code-execution-service
          image: akashcapro/codex-code-execution-service-k8s:0.0.4
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          env:
            - name: CODE_EXECUTION_SERVICE_METRICS_PORT
              value: "9104"
            - name: REDIS_URL
              value: "redis://redis:6379"
            - name: KAFKA_IDEMPOTENCY_KEY_EXPIRY
              value: "600"
            - name: KAFKA_CODE_EXECUTION_SERVICE_CLIENT_ID
              value: "code-execution-service"
            - name: KAFKA_BROKERS
              value: "kafka:9092"
            - name: KAFKA_CODE_EXECUTION_SERVICE_GROUP_ID
              value: "code-execution-group"
            - name: KAFKA_MAX_RETRIES
              value: "3"
            - name: KAFKA_RETRY_QUEUE_CAP
              value: "100000"
            - name: "WORKER_IMAGE_NAME"
              value: "akashcapro/codex-sandbox"
            - name: EXECUTION_TIMEOUT
              value: "10000"
            - name: MAX_OUTPUT_LENGTH
              value: "5000"
            - name: CONTAINER_POOL_SIZE
              value: "4"
            - name: DOCKER_HOST
              value: "localhost" 
            - name: DOCKER_PORT
              value: "2375"
            - name: DOCKER_LOCAL
              value: "/var/run/docker.sock"
            - name: OTEL_SERVICE_NAME
              value: "code-execution-service"
            # - name: OTEL_EXPORTER_OTLP_ENDPOINT
            #   value: "otel-collector-opentelemetry-collector.observability.svc.cluster.local:4317" 
        # container 2: Docker Daemon
        - name: docker-daemon
          image: docker:dind
          imagePullPolicy: IfNotPresent
          securityContext: 
            privileged: true
          env:
            - name: DOCKER_TLS_CERTDIR
              value: ""  
          args: ["--host=tcp://0.0.0.0:2375", "--storage-driver=overlay2"]
          volumeMounts: 
            - name: dind-storage
              mountPath: /var/lib/docker
          resources:
            requests:
              cpu: "300m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
      volumes:
        - name: dind-storage
          emptyDir: {}
