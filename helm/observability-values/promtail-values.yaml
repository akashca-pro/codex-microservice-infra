# values/promtail-values.yaml
config:
  clients:
    # This points Promtail to the Loki service you just configured
    - url: http://loki.observability.svc.cluster.local:3100/loki/api/v1/push

  scrape_configs:
    - job_name: kubernetes-pods
      # This automatically discovers all pods in the cluster
      kubernetes_sd_configs:
        - role: pod
      
      # This pipeline processes logs from the discovered pods
      pipeline_stages:
        # Stage 1: Parse the log line as JSON, which your Pino logger creates
        - json:
            # Stage 2: Extract the 'traceId' from the JSON log content.
            # Your logger uses camelCase 'traceId', so we match that here.
            expressions:
              trace_id: traceId 

        # Stage 3: Promote the extracted field to a permanent, searchable Loki label
        - labels:
            trace_id:
      
      # This adds useful metadata labels from Kubernetes to every log line
      relabel_configs:
        # This takes the 'app' label from your Deployments (e.g., app: gateway-service)
        # and turns it into a searchable Loki label. This is essential.
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: app
        
        # Add other useful labels for filtering
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod